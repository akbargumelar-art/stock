generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  VIEWER
}

enum LocationType {
  PHYSICAL
  VIRTUAL
}

enum MovementType {
  IN
  OUT
  LOAN_OUT
  LOAN_RETURN
  SALE
}

enum LoanStatus {
  ACTIVE
  RETURNED
  OVERDUE
}

model User {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(100)
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255)
  role      Role     @default(VIEWER)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  categoryVisibility CategoryVisibility[]
  productsCreated    Product[]
  movements          Movement[]
  auditTrail         AuditTrail[]

  @@map("users")
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  prefix      String?  @db.VarChar(10)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  products           Product[]
  categoryVisibility CategoryVisibility[]

  @@map("categories")
}

model CategoryVisibility {
  id         Int    @id @default(autoincrement())
  userId     String @map("user_id")
  categoryId Int    @map("category_id")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@map("category_visibility")
}

model Product {
  id           Int      @id @default(autoincrement())
  sku          String   @unique @db.VarChar(50)
  name         String   @db.VarChar(255)
  categoryId   Int      @map("category_id")
  description  String?  @db.Text
  unit         String   @default("pcs") @db.VarChar(50)
  price        Int      @default(0)
  costPrice    Int      @default(0) @map("cost_price")
  image        String?  @db.Text
  minStock     Int      @default(0) @map("min_stock")
  currentStock Int      @default(0) @map("current_stock")
  qrCode       String?  @db.Text @map("qr_code")
  createdBy    String?  @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  category         Category          @relation(fields: [categoryId], references: [id])
  creator          User?             @relation(fields: [createdBy], references: [id])
  productLocations ProductLocation[]
  movements        Movement[]
  loans            Loan[]
  saleItems        SaleItem[]

  @@map("products")
}

model Location {
  id          Int          @id @default(autoincrement())
  name        String       @db.VarChar(100)
  type        LocationType
  parentId    Int?         @map("parent_id")
  description String?      @db.Text
  createdAt   DateTime     @default(now()) @map("created_at")

  parent           Location?         @relation("LocationHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children         Location[]        @relation("LocationHierarchy")
  productLocations ProductLocation[]
  movementsFrom    Movement[]        @relation("MovementFrom")
  movementsTo      Movement[]        @relation("MovementTo")

  @@map("locations")
}

model ProductLocation {
  id         Int @id @default(autoincrement())
  productId  Int @map("product_id")
  locationId Int @map("location_id")
  quantity   Int @default(0)

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([productId, locationId])
  @@map("product_locations")
}

model Movement {
  id             Int          @id @default(autoincrement())
  productId      Int          @map("product_id")
  type           MovementType @default(IN)
  fromLocationId Int?         @map("from_location_id")
  toLocationId   Int?         @map("to_location_id")
  quantity       Int
  notes          String?      @db.Text
  movedBy        String       @map("moved_by")
  createdAt      DateTime     @default(now()) @map("created_at")

  product      Product   @relation(fields: [productId], references: [id])
  fromLocation Location? @relation("MovementFrom", fields: [fromLocationId], references: [id])
  toLocation   Location? @relation("MovementTo", fields: [toLocationId], references: [id])
  mover        User      @relation(fields: [movedBy], references: [id])

  @@map("movements")
}

model Loan {
  id              String     @id @default(uuid())
  transactionCode String     @unique @map("transaction_code") @db.VarChar(30)
  borrowerName    String     @map("borrower_name") @db.VarChar(150)
  borrowerPhone   String     @map("borrower_phone") @db.VarChar(20)
  productId       Int        @map("product_id")
  qty             Int
  loanDate        DateTime   @default(now()) @map("loan_date")
  dueDate         DateTime   @map("due_date")
  returnDate      DateTime?  @map("return_date")
  status          LoanStatus @default(ACTIVE)
  lastNotifiedAt  DateTime?  @map("last_notified_at")
  notes           String?    @db.Text
  createdAt       DateTime   @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id])

  @@map("loans")
}

model Sale {
  id           String   @id @default(uuid())
  invoiceCode  String   @unique @map("invoice_code") @db.VarChar(30)
  customerName String?  @map("customer_name") @db.VarChar(150)
  totalAmount  Int      @default(0) @map("total_amount")
  saleDate     DateTime @default(now()) @map("sale_date")
  createdAt    DateTime @default(now()) @map("created_at")

  items SaleItem[]

  @@map("sales")
}

model SaleItem {
  id           Int @id @default(autoincrement())
  saleId       String @map("sale_id")
  productId    Int    @map("product_id")
  qty          Int
  sellingPrice Int    @map("selling_price")
  costPrice    Int    @default(0) @map("cost_price")

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("sale_items")
}

model AuditTrail {
  id         Int      @id @default(autoincrement())
  userId     String   @map("user_id")
  action     String   @db.VarChar(50)
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id") @db.VarChar(50)
  details    Json?
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("audit_trail")
}
